import { createClient } from '@supabase/supabase-js';\nimport dotenv from 'dotenv';\ndotenv.config();\n\nconst supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);\n\nasync function testSoftModeration() {\n  console.log('ğŸ§ª Testing Automated Soft Moderation System\\n');\n  \n  try {\n    // 1. Create a test message\n    console.log('1. Creating test community message...');\n    const testMessage = {\n      whatsapp_id: 'test_' + Date.now(),\n      from_number: '+27123456789',\n      message_type: 'text',\n      content: 'Community garden project starting next week in Soweto. Free vegetables for all families. Join us Saturday 9am at the community center.',\n      language_detected: 'eng',\n      processed: false\n    };\n    \n    const { data: message, error: msgError } = await supabase\n      .from('messages')\n      .insert(testMessage)\n      .select()\n      .single();\n    \n    if (msgError) throw msgError;\n    console.log('âœ… Test message created:', message.id);\n    \n    // 2. Wait for MCP analysis trigger\n    console.log('\\n2. Waiting for MCP analysis...');\n    await new Promise(resolve => setTimeout(resolve, 2000));\n    \n    // 3. Check advisory was created\n    const { data: advisory } = await supabase\n      .from('advisories')\n      .select('*')\n      .eq('message_id', message.id)\n      .single();\n    \n    if (advisory) {\n      console.log('âœ… MCP advisory created');\n      console.log('   Escalation suggested:', advisory.escalation_suggested);\n      console.log('   Confidence:', advisory.confidence);\n    } else {\n      console.log('âŒ No advisory found');\n    }\n    \n    // 4. Manually trigger auto-approval process\n    console.log('\\n3. Running auto-approval process...');\n    const { data: processedCount, error: processError } = await supabase\n      .rpc('process_auto_approval_queue');\n    \n    if (processError) throw processError;\n    console.log('âœ… Auto-approval processed:', processedCount, 'messages');\n    \n    // 5. Check if moment was created\n    console.log('\\n4. Checking for auto-created moment...');\n    const { data: moments } = await supabase\n      .from('moments')\n      .select('*')\n      .eq('created_by', 'auto_moderation')\n      .order('created_at', { ascending: false })\n      .limit(1);\n    \n    if (moments && moments.length > 0) {\n      const moment = moments[0];\n      console.log('âœ… Moment auto-created!');\n      console.log('   ID:', moment.id);\n      console.log('   Title:', moment.title);\n      console.log('   Category:', moment.category);\n      console.log('   Status:', moment.status);\n      console.log('   Publish to PWA:', moment.publish_to_pwa);\n      \n      // 6. Check if intents were created\n      const { data: intents } = await supabase\n        .from('moment_intents')\n        .select('*')\n        .eq('moment_id', moment.id);\n      \n      console.log('\\n5. Moment intents:', intents?.length || 0);\n      if (intents && intents.length > 0) {\n        intents.forEach(intent => {\n          console.log(`   ${intent.channel}: ${intent.status}`);\n        });\n      }\n      \n    } else {\n      console.log('âŒ No auto-created moment found');\n    }\n    \n    // 7. Check message was marked as processed\n    const { data: updatedMessage } = await supabase\n      .from('messages')\n      .select('processed')\n      .eq('id', message.id)\n      .single();\n    \n    console.log('\\n6. Message processed:', updatedMessage?.processed || false);\n    \n    console.log('\\nğŸ‰ Soft moderation test completed!');\n    \n  } catch (error) {\n    console.error('âŒ Test failed:', error.message);\n  }\n}\n\n// Run test\ntestSoftModeration();